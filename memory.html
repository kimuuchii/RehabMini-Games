<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Memory Pattern | ‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏µ</title>
    <style>
        /* Shared & Base Styles */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        :root {
            --color-blue: #007AFF;
            --color-green: #34C759;
            --color-bg: #f0f0f0;
            --font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        body {
            font-family: var(--font-family);
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            background-color: var(--color-bg);
        }
        .settings-panel, .result-panel {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        h2 { color: var(--color-blue); font-size: 2rem; margin-top: 0; text-align: center; }
        .home-button { background-color: var(--color-blue); color: white; width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1.4rem; font-weight: 700; cursor: pointer; margin-top: 10px; transition: all 0.15s; }
        .home-button:active { transform: translateY(2px); }

        /* Game Area */
        #gameArea {
            display: none;
            width: 90vw;
            max-width: 600px;
        }
        .color-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            height: 90vw;
            max-height: 600px;
            margin: 20px 0;
        }
        .color-pad {
            border-radius: 15px;
            transition: all 0.2s ease-out;
            border: 5px solid #333;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: #fff;
            opacity: 0.8;
        }
        .color-pad:active, .color-pad.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        .game-info {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }
        .result-panel .level { font-size: 3rem; color: var(--color-green); }
    </style>
    <script src="shared.js"></script>
</head>
<body>
    <div class="settings-panel" id="settingsPanel">
        <button class="home-button" onclick="goTo('index.html')">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <h2>üß† Memory Pattern</h2>
        <p>‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≥‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
        <button class="home-button" style="background-color: var(--color-green);" onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    </div>

    <div id="gameArea">
        <div class="game-info" id="gameInfo"></div>
        <div class="color-grid" id="colorGrid">
            <div class="color-pad" data-index="0" style="background-color: #FF3B30;"></div>
            <div class="color-pad" data-index="1" style="background-color: #34C759;"></div>
            <div class="color-pad" data-index="2" style="background-color: #007AFF;"></div>
            <div class="color-pad" data-index="3" style="background-color: #FF9500;"></div>
        </div>
    </div>

    <div class="result-panel" id="resultPanel" style="display: none;">
        <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
        <p>‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á **‡∏£‡∏∞‡∏î‡∏±‡∏ö**:</p>
        <p><span id="finalLevel" class="level"></span></p>
        <button class="home-button" style="background-color: var(--color-green);" onclick="window.location.reload()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="home-button" onclick="goTo('index.html')">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

<script>
    const colors = [
        { index: 0, name: '‡πÅ‡∏î‡∏á', hex: '#FF3B30' },
        { index: 1, name: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', hex: '#34C759' },
        { index: 2, name: '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', hex: '#007AFF' },
        { index: 3, name: '‡∏™‡πâ‡∏°', hex: '#FF9500' }
    ];
    let sequence = [];
    let playerSequence = [];
    let currentLevel = 0;
    let isPlayerTurn = false;
    let isGameRunning = false;

    // Helper to blink a color pad
    function flashPad(index) {
        return new Promise(resolve => {
            const pad = document.querySelector(`.color-pad[data-index="${index}"]`);
            if (!pad) return resolve();
            
            beep(1);
            pad.classList.add('active');
            setTimeout(() => {
                pad.classList.remove('active');
                setTimeout(resolve, 150); // Delay between flashes
            }, 300); // Flash duration
        });
    }

    async function showSequence() {
        isPlayerTurn = false;
        document.getElementById('gameInfo').textContent = `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${currentLevel}: ‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏à‡∏≥`;
        await new Promise(r => setTimeout(r, 1000));

        for (const index of sequence) {
            await flashPad(index);
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        playerSequence = [];
        isPlayerTurn = true;
        document.getElementById('gameInfo').textContent = `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${currentLevel}: ‡πÅ‡∏ï‡∏∞‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö`;
    }

    function generateNextSequence() {
        const newIndex = Math.floor(Math.random() * colors.length);
        sequence.push(newIndex);
        currentLevel = sequence.length;
        showSequence();
    }

    function checkPlayerInput(tappedIndex) {
        if (!isPlayerTurn) return;

        playerSequence.push(tappedIndex);
        
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const expectedIndex = sequence[playerSequence.length - 1];

        if (tappedIndex !== expectedIndex) {
            // ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            isGameRunning = false;
            isPlayerTurn = false;
            toast('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!');
            beep(2);
            showResult();
            return;
        }
        
        // ‡πÅ‡∏ï‡∏∞‡∏ñ‡∏π‡∏Å: flash ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á
        flashPad(tappedIndex); 

        // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (playerSequence.length === sequence.length) {
            // ‡∏à‡∏ö‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            isPlayerTurn = false;
            toast(`‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö ${currentLevel}!`);
            setTimeout(generateNextSequence, 1000); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        }
    }

    function showResult() {
        document.getElementById('gameArea').style.display = 'none';
        // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á sequence ‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢ 1 (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)
        document.getElementById('finalLevel').textContent = Math.max(0, currentLevel - 1); 
        document.getElementById('resultPanel').style.display = 'block';
    }

    function setupGamePads() {
        document.querySelectorAll('.color-pad').forEach(pad => {
            pad.addEventListener('touchstart', (e) => {
                e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô double tap zoom
                checkPlayerInput(parseInt(pad.dataset.index));
            });
            pad.addEventListener('mousedown', (e) => {
                checkPlayerInput(parseInt(pad.dataset.index));
            });
        });
    }

    function startGame() {
        isGameRunning = true;
        sequence = [];
        currentLevel = 0;
        
        document.getElementById('settingsPanel').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        setupGamePads();

        countdownOverlay(3, () => {
            generateNextSequence(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
        });
    }

</script>
</body>
</html>
